<!DOCTYPE html><html lang="ja">
<head>
	<meta charset="utf-8" />
	<title>n138-kz.github.io</title>
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width,initial-scale=1">
	<meta http-equiv="Pragma" content="no-cache">
	<meta http-equiv="Cache-Control" content="no-cache">
	<meta http-equiv="Expires" content="0">
	<link rel="preconnect dns-prefetch" href="//github.com">
	<link rel="preconnect dns-prefetch" href="//n138-kz.github.io">
	<link rel="preconnect dns-prefetch" href="//code.jquery.com">
	<link rel="preconnect dns-prefetch" href="//accounts.google.com">
	<link rel="preconnect dns-prefetch" href="//www.google.com">
	<link rel="stylesheet" type="text/css" href="https://n138-kz.github.io/lib/master.css?t=0" />
	<script src="https://n138-kz.github.io/lib/master.js"></script>
	<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
	<script src="https://accounts.google.com/gsi/client" async defer></script>
	<script src="https://www.google.com/recaptcha/api.js?render=6LfCHdcUAAAAAOwkHsW_7W7MfoOrvoIw9CXdLRBA"></script>
	<script src="https://n138-kz.github.io/lib/grecaptcha.js"></script>
	<script>
		class URL {
			getQuery () {
				let query_list = get_GETarray((decodeURI(location.search)+'&').replace(/^\?/,''));
				query_list.code = ( query_list.code === "" || query_list.code === null || query_list.code === undefined )?'':query_list.code;
				query_list.access_token = ( query_list.access_token === "" || query_list.access_token === null || query_list.access_token === undefined )?'':query_list.access_token;
				query_list.error = ( query_list.error === "" || query_list.error === null || query_list.error === undefined )?'':query_list.error;
				query_list.error_description = ( query_list.error_description === "" || query_list.error_description === null || query_list.error_description === undefined )?'':decodeURIComponent(query_list.error_description.replace(/\+/g,'%20'));
				return query_list;
			}
		}
		class Discord {
			logger (level='info', content='') {
				let log = {
					date: (new Date).toISOString(),
					level: level,
					data: content,
				};
				let logstorage = sessionStorage.getItem( (btoa(location.href)).slice(0, 16) + '.'+'log' );
				try { logstorage = ( logstorage === "" || logstorage === null || logstorage === undefined ) ? [] : JSON.parse(logstorage); } catch { logstorage = [] };
				logstorage.unshift(log);
				sessionStorage.setItem( (btoa(location.href)).slice(0, 16) + '.'+'log', JSON.stringify(logstorage) );
				sessionStorage.setItem( (btoa(location.href)).slice(0, 16) + '.'+'log_latest', JSON.stringify(log) );
			}
			async login (qlist) {
				if ( qlist.error !== '' || qlist.error_description !== '' ) {
					let dom = [];
					dom[0] = document.createElement('div');
					dom[0].classList.add('error');
					dom[1] = document.createElement('h2');
					dom[1].innerText = `${qlist.error}`;
					dom[0].appendChild(dom[1]);
					dom[1] = document.createElement('div');
					dom[1].innerText = `${qlist.error_description}`;
					dom[0].appendChild(dom[1]);

					document.body.prepend(dom[0]);
					return qlist;
				}
				
				if ( qlist.code !== '' ) {
					await this.getAccessToken(qlist.code);
				}
			}
			async getAccessToken (code) {
				try {
					let url, req, res;
					url = `https://api.n138.jp/sso_discord/server/token.php?&redirect_url=${location.origin}${location.pathname}&code=${code}`;
					req = await fetch(url, {
						cache: 'no-store',
					});
					
					if (await req.status>299||await req.status<200) {
						throw new Error(`HTTP Error: ${await req.statusText}(code:${await req.status}) ${req.url}`, {cause: `HTTP ${await req.status} Error`});
					}
					res = await req.json();
					res.oauth2_token.expires_at = new Date((Date.now()/10**3+res.oauth2_token.expires_in)*10**3);
					console.debug({ url:url, req:req, res:res, });

					sessionStorage.setItem( (btoa(location.href)).slice(0, 16) + '.'+'oauth2_token', JSON.stringify(res.oauth2_token) );
					this.logger('info', `code:${code} -> token:${res.oauth2_token.access_token}`);
					location.replace( `${location.origin}${location.pathname}?access_token=${res.oauth2_token.access_token}` );
				} catch(e) {
					console.error(e, {name: e.name, message: e.message, stack: e.stack});
					this.logger('error', e.stack);
					location.replace( `${location.origin}${location.pathname}?error=access_denied&error_description=[getAccessToken]+Something+Error+has+occurred.+Please+show+log+in+sessionStorage.log` );
				}
			}
		}
		window.addEventListener('DOMContentLoaded', async ()=>{
			console.log('DOMContentLoaded');
			
			try { api = ( api === "" || api === null || api === undefined ) ? {} : api; } catch { api = {} };
			api.discord = new Discord();
			api.discord.login( (new URL).getQuery() );
			
		});
	</script>
	<style>
		.font_isometric {
			font-family: monospace, "MSゴシック", "MeiryoKe_Console", "BIZ UDゴシック", "UDデジタル教科書体", "Cascadia Code", "Cascadia Mono";
		}
		.mosaic {
			filter: blur(3px);
		}
		.mosaic_strong {
			filter: blur(10px);
		}
		div.error {
			background-color: pink;
			padding: 10px;
			margin-top: 0;
			margin-bottom: 100px;
		}
	</style>
</head>
<body>
	<form action="" method="GET">
		<fieldset>
			<legend>Login</legend>
			<a href="https://discord.com/oauth2/authorize?client_id=1331215597119340585&response_type=code&redirect_uri=https://api.n138.jp/joinImg/repo2/docs/&scope=identify+openid+guilds" target="_self"><img alt="Login with Discord" src="https://cdn.prod.website-files.com/6257adef93867e50d84d30e2/66e3d74e9607e61eeec9c91b_Logo.svg"></a>
		</fieldset>
		<fieldset>
			<legend>Direction</legend>
			<select>
				<option value="vertical">垂直, Vertical</option>
				<option value="horizontal">水平, Horizontal</option>
			</select>
		</fieldset>
		<fieldset>
			<legend>Files</legend>
			<div>
				<input type="button" value="+">
				<input type="button" value="-" class="font_isometric">
				<input type="url" name="links[]" placeholder="https://example.net/images1.png">
			</div>
			<div>
				<input type="button" value="+">
				<input type="button" value="-" class="font_isometric">
				<input type="url" name="links[]" placeholder="https://example.net/images2.png">
			</div>
		</fieldset>
	</form>
</body>
</html>
